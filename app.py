# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/19E1JnLyW9HqjqodN4jTc2RK3huPqzXuN
"""

import streamlit as st
import pandas as pd
from utils.fit import fit_model
from models.nca import run_nca
from utils.plots import plot_prediction, plot_residuals, plot_terminal_phase
from utils.download import generate_download_button
from utils.model_comparison import compare_models, display_comparison
from utils.residuals import calculate_residuals, residual_summary, plot_residual_distribution, plot_residuals_vs_pred

st.set_page_config(page_title="PK ëª¨ë¸ë§ ì•±", layout="wide")
st.title("ğŸ’Š ì•½ë¬¼ë™íƒœí•™ ëª¨ë¸ë§ í”Œë«í¼")

st.sidebar.header("âš™ï¸ ì„¤ì •")
model = st.sidebar.selectbox("ëª¨ë¸ ì„ íƒ", [
    "1 ì»´íŒŒíŠ¸ë¨¼íŠ¸ IV bolus",
    "1 ì»´íŒŒíŠ¸ë¨¼íŠ¸ PO",
    "2 ì»´íŒŒíŠ¸ë¨¼íŠ¸ IV bolus",
    "2 ì»´íŒŒíŠ¸ë¨¼íŠ¸ PO",
    "IV infusion (PI)"
])

method = st.sidebar.radio("ê³„ì‚° ë°©ì‹ ì„ íƒ", ["ì§€ìˆ˜í•¨ìˆ˜ ê¸°ë°˜", "ODE ê¸°ë°˜"])

with st.expander("ğŸ“‚ ë°ì´í„° ì—…ë¡œë“œ ë˜ëŠ” ì˜ˆì œ ì‚¬ìš©"):
    uploaded = st.file_uploader("CSV íŒŒì¼ ì—…ë¡œë“œ (time, conc ì—´ í¬í•¨)", type=["csv"])
    if uploaded:
        data = pd.read_csv(uploaded)
    else:
        st.info("ì˜ˆì œ ë°ì´í„° ì‚¬ìš© ì¤‘")
        data = pd.DataFrame({
            "time": [0.5, 1, 2, 3, 4, 6, 8, 12],
            "conc": [15.2, 13.5, 10.3, 7.4, 5.1, 3.2, 2.1, 1.1]
        })

st.write("### ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°")
st.dataframe(data)

st.sidebar.markdown("---")
dose = st.sidebar.number_input("íˆ¬ì—¬ëŸ‰ (Dose, mg)", value=100.0)
if model == "IV infusion (PI)":
    R = st.sidebar.number_input("ì£¼ì… ì†ë„ (Rate, mg/hr)", value=10.0)
    duration = st.sidebar.number_input("ì£¼ì… ì‹œê°„ (hr)", value=2.0)
else:
    R = None
    duration = None

st.markdown("---")
st.header("ğŸ“Œ ëª¨ë¸ ì í•© ê²°ê³¼")
result = fit_model(data, model, method, dose=dose, R=R, duration=duration)

st.write("#### ì¶”ì • íŒŒë¼ë¯¸í„°")
st.json(result['params'])

plot_prediction(data, result['pred'])
plot_residuals(data, result['pred'])

st.markdown("---")
st.header("ğŸ“‰ NCA ë¶„ì„")
manual = st.checkbox("í„°ë¯¸ë„ í˜ì´ì¦ˆ ìˆ˜ë™ ì„ íƒ")
if manual:
    selected_times = st.multiselect("í„°ë¯¸ë„ í˜ì´ì¦ˆë¡œ ì‚¬ìš©í•  ì‹œê°„ ì„ íƒ", data['time'].tolist())
else:
    selected_times = None
nca_result = run_nca(data, selected_times, use_manual=manual)
st.write("#### NCA íŒŒë¼ë¯¸í„°")
st.json(nca_result['params'])
plot_terminal_phase(data, nca_result['pred'], selected_times)

st.markdown("---")
st.header("ğŸ“Š ëª¨ë¸ ë¹„êµ (AIC/BIC)")
if st.button("ëª¨ë¸ ë¹„êµ ì‹¤í–‰"):
    comp_df = compare_models(data, method, dose=dose, R=R, duration=duration)
    display_comparison(comp_df, st)

st.markdown("---")
st.header("ğŸ“¤ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ")
generate_download_button(result)

st.markdown("---")
st.header("ğŸ“Œ ì”ì°¨ í†µê³„ ë° ë¶„í¬ ë¶„ì„")
res = calculate_residuals(data, result['pred'])
st.write(residual_summary(res))
plot_residual_distribution(res)
plot_residuals_vs_pred(result['pred'], res)